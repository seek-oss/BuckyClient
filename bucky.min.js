/*! ca-bucky-client 0.2.8 */
(function(){var a,b,c,d,e,f,g,h=[].slice,i={}.hasOwnProperty;e="undefined"!=typeof module&&null!==module&&("undefined"==typeof window||null===window),e?(a=require("xmlhttprequest").XMLHttpRequest,g=function(){var a;return a=process.hrtime(),1e3*(a[0]+a[1]/1e9)}):g=function(){var a,b;return null!=(a=null!=(b=window.performance)&&"function"==typeof b.now?b.now():void 0)?a:+new Date},d=+new Date,c=function(){var a,b,c,d,e,f,g;for(a=arguments[0],d=2<=arguments.length?h.call(arguments,1):[],f=0,g=d.length;g>f;f++){c=d[f];for(b in c)e=c[b],a[b]=e}return a},f=function(){var a,b;return a=1<=arguments.length?h.call(arguments,0):[],null!=("undefined"!=typeof console&&null!==console&&null!=(b=console.log)?b.call:void 0)?console.log.apply(console,a):void 0},f.error=function(){var a,b;return a=1<=arguments.length?h.call(arguments,0):[],null!=("undefined"!=typeof console&&null!==console&&null!=(b=console.error)?b.call:void 0)?console.error.apply(console,a):void 0},b=function(){var b,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J;if(o={host:"/bucky",maxInterval:3e4,aggregationInterval:5e3,decimalPrecision:3,sendLatency:!1,sample:1,active:!0,extraHeaders:{}},C={},!e&&(b="undefined"!=typeof document&&document&&"function"==typeof document.querySelector?document.querySelector("[data-bucky-host],[data-bucky-page],[data-bucky-requests]"):null))for(C={host:b.getAttribute("data-bucky-host"),pagePerformanceKey:b.getAttribute("data-bucky-page"),requestsKey:b.getAttribute("data-bucky-requests")},H=["pagePerformanceKey","requestsKey"],F=0,G=H.length;G>F;F++)r=H[F],"true"===(null!=(I=C[r])?I.toString().toLowerCase():void 0)||""===C[r]?C[r]=!0:"false"===(null!=(J=C[r])?J.toString().toLowerCase():void 0)&&(C[r]=null);return w=c({},o,C),l={timer:"ms",gauge:"g",counter:"c"},j=w.active,(D=function(){return j=w.active&&Math.random()<w.sample})(),k=[],B=function(a){return c(w,a),("sample"in a||"active"in a)&&D(),w},y=function(a,b){return null==b&&(b=w.decimalPrecision),Math.round(a*Math.pow(10,b))/Math.pow(10,b)},x={},p=function(a,b,c,d){var e,f,g;return null==d&&(d=[]),j?(e=1,r="",d&&d instanceof Array&&d.length?(f=d.join(","),r=""+a+"+"+c+"+"+f):r=""+a+"+"+c,r in x&&("counter"===c?b+=x[r].value:(e=null!=(g=x[r].count)?g:e,e++,b=x[r].value+(b-x[r].value)/e)),x[r]={path:a,value:b,type:c,count:e,tags:d},n()):void 0},A=null,v=null,q=function(){return clearTimeout(A),clearTimeout(v),v=null,A=null,z()},n=function(){return clearTimeout(A),A=setTimeout(q,w.aggregationInterval),null==v?v=setTimeout(q,w.maxInterval):void 0},u=function(b){var c,d,f,h,j,k,l,m,n,o,p,q;d=e||window.XMLHttpRequest&&(window.XMLHttpRequest.defake||"withCredentials"in new window.XMLHttpRequest),e?l=!0:(f=/^(https?:\/\/[^\/]+)/i.exec(w.host),f?(j=f[1],l=j===""+document.location.protocol+"//"+document.location.host?!0:!1):l=!0),m=g(),c="";for(h in b)n=b[h],c+=""+n.path+":"+n.value+"\n";k=l||d||null==("undefined"!=typeof window&&null!==window?window.XDomainRequest:void 0)?new(null!=(p="undefined"!=typeof window&&null!==window?window.XMLHttpRequest:void 0)?p:a):new window.XDomainRequest,k.bucky={track:!1},k.open("POST",""+w.host+"/v1/send",!0),k.setRequestHeader("Content-Type","text/plain"),q=w.extraHeaders;for(r in q)i.call(q,r)&&(o=q[r],k.setRequestHeader(r,o));return k.addEventListener("load",function(){return E(g()-m)},!1),k.send(c),k},z=function(){var a,b,c,d,e;if(!j)return void f("Would send bucky queue");a={};for(r in x)b=x[r],k.push({path:b.path,count:b.count,type:b.type,value:b.value,tags:b.tags}),null!=l[b.type]?(d=b.value,("gauge"===(e=b.type)||"timer"===e)&&(d=y(d)),a[r]={path:b.path,value:""+d+"|"+l[b.type]},1!==b.count&&(a[r].value+="|@"+y(1/b.count,5)),b.tags&&b.tags instanceof Array&&b.tags.length&&(c=b.tags.join(","),a[r].value+="|#"+c)):f.error("Type "+b.type+" not understood by Bucky");return u(a),x={}},s=!1,E=function(a){return w.sendLatency&&!s?(p("bucky.latency",a,"timer"),s=!0,setTimeout(function(){return s=!1},3e5)):void 0},t=function(a){var b,c,e,i,l,m,n,o,s,u;null==a&&(a=""),b=function(b){return(null!=a?a.length:void 0)?a+"."+b:b},m=function(a,c,d,e){return null==d&&(d="gauge"),null==e&&(e=[]),null==c||null==a?void f.error("Can't log "+a+":"+c):p(b(a),c,d,e)},s={TIMES:{},send:function(a,b,c){return null==c&&(c=[]),m(a,b,"timer",c)},time:function(){var a,b,c,d,e,f;return e=arguments[0],f=arguments[1],a=arguments[2],c=arguments[3],b=5<=arguments.length?h.call(arguments,4):[],null==f&&(f=[]),s.start(e),d=function(){return s.stop(e,f)},b.splice(0,0,d),a.apply(c,b)},timeSync:function(){var a,b,c,d,e,f;return d=arguments[0],f=arguments[1],a=arguments[2],c=arguments[3],b=5<=arguments.length?h.call(arguments,4):[],null==f&&(f=[]),s.start(d),e=a.apply(c,b),s.stop(d,f),e},wrap:function(a,b,c){return null==b&&(b=[]),null!=c?function(){var d;return d=1<=arguments.length?h.call(arguments,0):[],s.timeSync.apply(s,[a,b,c,this].concat(h.call(d)))}:function(c){return function(){var d;return d=1<=arguments.length?h.call(arguments,0):[],s.timeSync.apply(s,[a,b,c,this].concat(h.call(d)))}}},start:function(a){return s.TIMES[a]=g()},stop:function(a,b){var c;return null==s.TIMES[a]?void f.error("Timer "+a+" ended without having been started"):(c=g()-s.TIMES[a],s.TIMES[a]=void 0,s.send(a,c,b))},stopwatch:function(a,b,c){var d,e;return null==c&&(c=[]),null!=b?e=function(){return+new Date}:(e=g,b=e()),d=b,{mark:function(c,d,f){var g;return null==d&&(d=0),g=e(),a&&(c=a+"."+c),s.send(c,g-b+d,f)},split:function(b,f){var g;return null==f&&(f=0),g=e(),a&&(b=a+"."+b),s.send(b,g-d+f,c),d=g}}},mark:function(a,b,c){var d;return null==c&&(c=[]),null==b&&(b=+new Date),d=s.navigationStart(),s.send(a,b-d,c)},navigationStart:function(){var a,b,c;return null!=(a="undefined"!=typeof window&&null!==window&&null!=(b=window.performance)&&null!=(c=b.timing)?c.navigationStart:void 0)?a:d},responseEnd:function(){var a,b,c;return null!=(a="undefined"!=typeof window&&null!==window&&null!=(b=window.performance)&&null!=(c=b.timing)?c.responseEnd:void 0)?a:d},now:function(){return g()}},c=function(a,b,c){return null==b&&(b=[]),null==c&&(c=1),m(a,c,"counter",b)},o=!1,n=function(a,b){var c,d,e,f,g,h,i=this;if(null==b&&(b=[]),null==("undefined"!=typeof window&&null!==window&&null!=(f=window.performance)?f.timing:void 0))return!1;if(o)return!1;if(a&&a!==!0||(a=l.urlToKey(document.location.toString())+".page"),"uninitialized"===(g=document.readyState)||"loading"===g)return"function"==typeof window.addEventListener&&window.addEventListener("load",function(){return setTimeout(function(){return n.call(i,a,b)},500)},!1),!1;o=!0,c=window.performance.timing.navigationStart,h=window.performance.timing;for(r in h)e=h[r],"number"==typeof e&&(d=b.slice(0),d.push("perf-prop:"+r),s.send(a,e-c,d),d=[]);return!0},l={transforms:{mapping:{guid:/\/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/gi,sha1:/\/[0-9a-f]{40}/gi,md5:/\/[0-9a-f]{32}/gi,id:/\/[0-9;_\-]+/g,email:/\/[^\/]+@[^\/]+/g,domain:[/\/[^\/]+\.[a-z]{2,3}\//gi,"/"]},enabled:["guid","sha1","md5","id","email","domain"],enable:function(a,b,c){return null==c&&(c=""),null!=b&&(this.mapping[a]=[b,c]),this.enabled.splice(0,0,a)},disable:function(a){var b,c,d;d=this.enabled;for(b in d)if(c=d[b],c===a)return void this.enabled.splice(b,1)}},sendReadyStateTimes:function(a,b,c){var d,e,f,g,h,i,j,k;if(null==c&&(c=[]),null!=b){e={1:"sending",2:"headers",3:"waiting",4:"receiving"},f={},g=null;for(d in b)i=b[d],null!=g&&null!=e[d]&&(f[e[d]]=i-g),g=i;k=[];for(h in f)j=f[h],k.push(s.send(""+a+"."+h,j,c));return k}},urlToKey:function(a,b,c){var d,e,g,h,i,j,k,m,n,o;for(a=a.replace(/https?:\/\//i,""),h=/([^\/:]*)(?::\d+)?(\/[^\?#]*)?.*/i.exec(a),d=h[1],i=null!=(n=h[2])?n:"",o=l.transforms.enabled,k=0,m=o.length;m>k;k++)g=o[k],e=l.transforms.mapping[g],null!=e?"function"!=typeof e?(e instanceof RegExp&&(e=[e,""]),i=i.replace(e[0],e[1])):i=e(i,a,b,c):f.error("Bucky Error: Attempted to enable a mapping which is not defined: "+g);return i=decodeURIComponent(i),i=i.replace(/[^a-zA-Z0-9\-\.\/ ]+/g,"_"),j=d+i.replace(/[\/ ]/g,"."),j=j.replace(/(^\.)|(\.$)/g,""),j=j.replace(/\.com/,""),j=j.replace(/www\./,""),c&&(j=c+"."+j),b&&(j=j+"."+b.toLowerCase()),j=j.replace(/\.\./g,".")},getFullUrl:function(a,b){return null==b&&(b=document.location),/^\//.test(a)?b.hostname+a:/https?:\/\//i.test(a)?a:b.toString()+a},monitor:function(a,b){var d,e,h;return null==b&&(b=[]),a&&a!==!0||(a=l.urlToKey(document.location.toString())+".requests"),e=this,d=function(d){var f,h,i,j,k,l,n,o;return n=d.type,o=d.url,h=d.event,j=d.request,i=d.readyStateTimes,k=d.startTime,null!=k?(f=g()-k,o=e.getFullUrl(o),l=e.urlToKey(o,n,a),m(l,f,"timer",b),e.sendReadyStateTimes(l,i,b),null!=(null!=j?j.status:void 0)?(j.status>12e3?c(""+l+".0"):0!==j.status&&c(""+l+"."+j.status.toString().charAt(0)+"xx"),c(""+l+"."+j.status)):void 0):void 0},h=window.XMLHttpRequest,window.XMLHttpRequest=function(){var a,b,c,e,i,j;c=new h;try{e=null,b={},i=c.open,c.open=function(a,h,j){var k;try{b[0]=g(),c.addEventListener("readystatechange",function(){return b[c.readyState]=g()},!1),c.addEventListener("loadend",function(f){return null==c.bucky||c.bucky.track!==!1?d({type:a,url:h,event:f,startTime:e,readyStateTimes:b,request:c}):void 0},!1)}catch(l){k=l,f.error("Bucky error monitoring XHR open call",k)}return i.apply(c,arguments)},j=c.send,c.send=function(){return e=g(),j.apply(c,arguments)}}catch(k){a=k,f.error("Bucky error monitoring XHR",a)}return c}}},i=function(b){var c;return null==b&&(b=""),c=null!=a?a:"",c&&b&&(c+="."),b&&(c+=b),t(c)},e={send:m,count:c,timer:s,now:g,requests:l,sendPagePerformance:n,flush:q,setOptions:B,options:w,history:k,active:j};for(r in e)u=e[r],i[r]=u;return i},m=t(),w.pagePerformanceKey&&m.sendPagePerformance(w.pagePerformanceKey),w.requestsKey&&m.requests.monitor(w.requestsKey),m},"function"==typeof define&&define.amd?define(b):"object"==typeof exports?module.exports=b():window.Bucky=b()}).call(this);